---
title: <center> <h1> Trabalho Extração de Conhecimento de Dados Biológicos - Grupo 2 </h1> </center>
author: "Joana Gonçalves Pg49835, Bruno Sá Pg49832, Gonçalo Cardoso Pg49834, Luís Ferreira Pg49840"
date: <center>`r format(Sys.time(), '%d/%m/%y')`</center>
output:
  html_document:
    theme: spacelab #united, spacelab, journal
    highlight: kate #zenburn, kate, breezedark
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
    code_folding: show
---

\

<center>![](logo.jpg)</center>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{css, echo=FALSE}
.scroll {
  max-height: 300px;
  overflow-y: auto;
}
```

```{=html}
<style>
body {text-align: justify}
div.fontdoc {font-family: georgia;}
    body .main-container {
        max-width: 1750px;
    }
</style>
```
<div class = "fontdoc">

<font size="4">

<a name="topo"></a>

## Explicação dos dados, a sua origem e relevância

O National Cancer Institute (NCI) dos Estados Unidos gere o Genomic Data Commons (GDC), um repositório de dados que fornece acesso a dados genómicos e clínicos de vários projetos de pesquisa sobre vários tipos de cancro , incluindo o TCGA. O GDC fornece uma plataforma para bioinformáticos e clínicos acederem e analisarem os dados do TCGA - GBM juntamente com dados de outros estudos do TCGA e outros projetos.

Depois de analisarmos várias hipoteses de estudo para este trabalho decidimos analisar os dados recolhidos no seguinte [ensaio clínico](https://portal.gdc.cancer.gov/projects/TCGA-GBM). O TCGA - GBM é um estudo genómico que faz parte do projeto TCGA (The Cancer Genome Atlas ) e foca-se num tipo agressivo de cancro cerebral conhecido como glioblastoma multiforme (GBM) .

O objetivo do TCGA - GBM é entender as alterações genéticas e moleculares que ocorrem nesse tipo de cancro para desenvolver novas terapias e tratamentos mais eficazes .

As informações para o TCGA-GBM foram coletadas de amostras de tecido tumoral retiradas de pacientes com GBM , juntamente com detalhes clínicos como idade, sexo e tempo de sobrevivência. O estudo utilizou várias técnicas de análise genómica , como sequenciamento de DNA e RNA , para encontrar alterações genéticas , alterações no número de cópias de genes e expressão diferencial de genes.

Os dados do TCGA-GBM são extremamente importantes para a compreensão do glioblastoma multiforme e possibilitarão bioinformáticos e investigadores encontrar novos alvos terapêuticos para o tratamento desse tipo de cancro. Além disso, esses dados poderão ser usados para desenvolver novas terapias, identificar indicadores e melhorar o diagnóstico e tratamento de GBM .

# Import das Librarys

```{r}

library(TCGAbiolinks)
library(SummarizedExperiment)
library(DESeq2)
library(ggplot2)
library(edgeR)
library(limma)
library(Glimma)
library(gplots)
library(org.Mm.eg.db)
library(RColorBrewer)

```

# Recolha dos dados

### Importação dados de Expressão/Metadados

```{r}

proj = "TCGA-GBM"     
query = GDCquery(
  project = proj,
  data.category = "Transcriptome Profiling", 
  data.type = "Gene Expression Quantification",
  workflow.type = "STAR - Counts"
  )


GDCdownload(query)

data_rna_GBM= GDCprepare(query)
data_rna_GBM

```

### Importação dados dos Dados clinicos

```{r}

query_clin = GDCquery(project = "TCGA-GBM", 
                  data.category = "Clinical",
                  data.type = "Clinical Supplement", 
                  data.format = "BCR Biotab")

GDCdownload(query_clin)

clinical.GBM = GDCprepare(query_clin)
```

#teste

```{r}

assayNames(data_rna_GBM)

data_rna_GBM_assay = assay(data_rna_GBM, "unstranded" ) #escolha da assay

data_rna_GBM_assay

plot(data_rna_GBM_assay)

sum(is.na(data_rna_GBM_assay)) #Após uma análise do dataset data_rna_GBM_assay, verificamos que não há presença de valores omissos (NA).

data_rna_GBM_assay_scale = scale(data_rna_GBM_assay)   # Standardização
data_rna_GBM_assay_scale

#segunda parte do trabalho
#library("factoextra")
#pca_result <- prcomp(data_rna_GBM_assay_scale, scale = TRUE)
#pca_data <- as.data.frame(pca_result$x)
#pca_data
```

# Estrutura dos dados : Análise dos metadados

```{r}
gbm=data_rna_GBM
```



```{r}
assayNames(gbm)
```


```{r}
data_rna_GBM_assay = assay(gbm, "unstranded" )  #escolha da assay

```

```{r}
rowRanges(gbm)

```


```{r}
plot(data_rna_GBM_assay)
```

```{r}
boxplot(data_rna_GBM_assay, main="Gene expression distribution", col=1:175)
```

#Dimensão e classe do objeto (data_rna_GBM)

```{r}

dim(data_rna_GBM_assay)

class(data_rna_GBM_assay)



```

A partir desta análise percebemos que o data_rna_GBM tem 60660 linhas (que correspondem a genes) e 175 colunas (que correspondem a amostras) para além disso, é um objeto da classe RangedSummarizedExperiment, que faz parte do pacote SummarizedExperiment. Esta matriz contém as contagens brutas da espressão genética para cada amostra.


```{r}
sum(is.na(data_rna_GBM_assay)) #Após uma análise do dataset data_rna_GBM_assay, verificamos que não há presença de valores omissos (NA).

data_rna_GBM_assay_scale = scale(data_rna_GBM_assay)   # Standardização
data_rna_GBM_assay_scale




```

Esta standardização dos dados vai premitir que todos os valores de expressão dos genes tenham média zero e desvio padrão um.





Foram as selecionadas as colunas que correspondem aos metadados que consideramos mais pertinentes:

**meta_GBM\$race** --\> Representa a raça de cada paciente (white, black or african american).

**meta_GBM\$age_at_diagnosis** --\> Representa a idade, em dias, que o paciente foi diagnosticado.

**meta_GBM\$gender** --\> Representa o género dos pacientes (male, female).

meta_GBM\$paper_Grade\*\* --\> Representa o grau de malignidade do tumor (G4)

meta_GBM\$paper_IDH.status --\> Representa o estado do gene isocitrato desidrogenase (IDH) nas amostras (WT, Mutant)

meta_GBM\$patient --\> Representa o ID do Paciente

meta_GBM\$definition --\> Representa o tipo de amostra de tecido recolhida (Primary solid Tumor, Recurrent Solid Tumor, Solid Tissue Normal)

meta_GBM\$paper_Mutation.Count --\> Representa o número de mutações identificadas no genoma do paciente.

meta_GBM\$vital_status --\> Dados que indicam se o paciente está vivo ou morto no momento da coleta de dados.




## Matrizes counts

```{r}
countdata <- round(assays(data_rna_GBM)[["unstranded"]])
countdata
```
```{r}


gbm$race = as.factor(gbm$race)
gbm$age_diag=gbm$age_at_diagnosis
gbm$gender=as.factor(gbm$gender)
gbm$p_grade=gbm$paper_Grade
gbm$p_IDH = gbm$paper_IDH.status
gbm$patient = gbm$patient
gbm$tissue = as.factor(gbm$definition)
gbm$mutation = gbm$paper_Mutation.Count 
gbm$vital_st= as.factor(gbm$vital_status)

 

```


```{r}
round( colSums(assay(gbm)) / 1e6, 1 )  #(o segundo argumento de round informa quantos pontos decimais devem ser mantidos, ou seja queremos só 1 casa decimal).
```

##Pré-processamento dos dados

###Tratamento de valores omissos



```{r}
sum(is.na(race))
```
```{r}
sum(is.na(age_diag))
```

```{r}
sum(is.na(gender))
```

data_de = data_rna_GBM[,!is.na(data_rna_GBM$paper_IDH.status)]
data_de = data_rna_GBM[,!is.na(data_rna_GBM$paper_IDH.status)]
data_de = data_rna_GBM[,!is.na(data_rna_GBM$paper_IDH.status)]
data_de = data_rna_GBM[,!is.na(data_rna_GBM$paper_IDH.status)]
data_de = data_rna_GBM[,!is.na(data_rna_GBM$paper_IDH.status)]

```{r}
sum(is.na(p_grade))
```

```{r}
sum(is.na(p_IDH))
```


```{r}
sum(is.na(patient))

```

```{r}
sum(is.na(tissue))

```

```{r}
sum(is.na(mutation))

```

```{r}
sum(is.na(vital_st))

```
#Nota tirar NA!!! para fazer comando seguinte

```{r}
#remover NA das variáveis


```




```{r}
dds <- DESeqDataSet(gbm, design = ~ race + age_diag + gender + p_grade + p_IDH + patient + tissue + mutation + vital_st)
```







## Meta_GBM (colData) (vOU ADICIONAR A NOVA VERSÃO AQUI PARA NÃO PERDERMOS NADA SE ISTO FALHAR)


```{r}
coldata <- colData(gbm)
```

construção do objeto DESeqDataSet a partir da matriz de contagens e da tabela de informações de amostra, usamos:


```{r}
ddsMat <- DESeqDataSetFromMatrix(countData = countdata,
                                 colData = coldata,
                                 design = ~ race + age_diag + gender + p_grade + p_IDH + patient + tissue + mutation + vital_st)

```

## Análise exploratória e visualização

```{r}

```


(....) Não consegui continuar a fazer pq não consigo tirar os NA


--------------------


## Meta_GBM (colData)
O componente colData armazena informações sobre as colunas da matriz de expressão, como anotações de amostras, características dos indivíduos, tratamentos ou condições experimentais, entre outros metadados. Por isso, para analizarmos as colunas da matriz que indicamos anteriormente vamos ter de chamar este componente.


```{r}
meta_GBM =colData(gbm)

dim(meta_GBM)  # a tabela contém 175 linhas (amostras) e 107 colunas (informações sobre as amostras)

class(meta_GBM) #dataframe

colnames(meta_GBM) # nomes das colunas



```

Com esta tabela podemos realizar subconjuntos de colunas, filtrar dados com base em critérios específicos ou simplesmente visualizar informações relevantes sobre as amostras ou condições experimentais.

```{r}

race = as.factor(meta_GBM$race)
age_diag = meta_GBM$age_at_diagnosis
gender = as.factor(meta_GBM$gender)
p_grade = meta_GBM$paper_Grade
p_IDH = meta_GBM$paper_IDH.status
patient = meta_GBM$patient
tissue = as.factor(meta_GBM$definition)
mutation = meta_GBM$paper_Mutation.Count 
vital_st = as.factor(meta_GBM$vital_status) 

```

### Análise Gráfica Exploratõria Variáveis --\> race

```{r}
qplot(race,fill=race, main="Race")


table=table(race)
data=as.data.frame(table)
slices <- data$Freq
lbls <- data$race
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
pie(slices,labels = lbls, col = c("darkslategray1", "coral", "darkolivegreen1", "navajowhite"),
   main="Race")
```

### Análise Exploratõria Variáveis --\> age_diag

```{r}

hist(age_diag, col = c("lightblue"), main="Idade(em dias) em que o paciente foi diagnosticado", xlab = "Idade quando do diagnóstico (dias)", ylab = "Frequência")

 
```

### Análise Exploratõria Variáveis --\> gender

```{r}
qplot(gender, fill= gender)

table=table(gender)
data=as.data.frame(table)
slices <- data$Freq
lbls <- data$gender
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
pie(slices,labels = lbls, col = c("pink", "lightblue"), main="Género")

```

### Análise Exploratõria Variáveis --\> p_grade (nao faz sentido)

```{r}
qplot(p_grade, fill=p_grade, main="Estágio do Cancro")
```

### Análise Exploratõria Variáveis --\> p_IDH

```{r}
qplot(p_IDH, fill=p_IDH, main="Estado do gene isocitrato desidrogenase (IDH) nas amostras")

table=table(p_IDH)
data=as.data.frame(table)
slices <- data$Freq
lbls <- data$p_IDH
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
pie(slices,labels = lbls, col = c("lightblue","darkolivegreen1"), main="Estado do gene isocitrato desidrogenase (IDH) nas amostras")

```

### Análise Exploratõria Variáveis --\> patient

```{r}

qplot(patient) 
```

Problema: Existem casos em que varios pacientes tem o mesmo ID!

### Análise Exploratõria Variáveis --\> tissue

```{r}

qplot(tissue, fill=tissue, main="Representa o tipo de amostra de tecido recolhida")



table=table(tissue)
data=as.data.frame(table)
slices <- data$Freq
lbls <- data$tissue
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
pie(slices,labels = lbls, col = c("lightblue","darkolivegreen1", "navajowhite"), main="Representa o tipo de amostra de tecido recolhida")

```

### Análise Exploratória Variáveis --\> mutation

```{r}
hist(mutation, col = "darkolivegreen1", main = "Número de mutações identificadas no genoma do paciente.")
boxplot(mutation,main = "Número de mutações identificadas no genoma do paciente.", ylab= "Nº de Mutações", col= "darkolivegreen1")

```

### Análise Exploratõria Variáveis --\> vital_st

```{r}
qplot(vital_st, fill= vital_st, main="Estado vital do paciente no momento da coleta de dados")

table=table(vital_st)
data=as.data.frame(table)
slices <- data$Freq
lbls <- data$vital_st
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
pie(slices,labels = lbls, col = c("lightblue","darkolivegreen1", "navajowhite"), main="Estado vital do paciente no momento da coleta de dados")

```

#Análise da Expressão diferencial

A análise de expressão diferencial vai ser realizada usando o pacote DESeq2 do Bioconductor.

## DE - Análise da Espresão Diferencial do. IDH.staus




```{r}



data_rna_GBM$paper_IDH.status


qplot(data_rna_GBM$paper_IDH.status, fill="navajowhite") + ggtitle("Estado do gene isocitrato desidrogenase (IDH) nas amostras") 

```

```{r}


data_de = data_rna_GBM[,!is.na(data_rna_GBM$paper_IDH.status)] #retirar NA

ddsSE = DESeqDataSet(data_de, design = ~ paper_IDH.status)

keep = rowSums(counts(ddsSE)) >= 10  #Objetivo do filtro :filtrar as linhas da matriz (counts) que possuem baixos niveis de expressão em todas as amostras. 


ddsSE = ddsSE[keep,]
ddsSE = DESeq(ddsSE)

resultsNames(ddsSE)

res = results(ddsSE, name = "paper_IDH.status_WT_vs_Mutant")
dea = as.data.frame(res)


summary(res)


```

A análise da Expressão Diferencial foi feita no subconjunto dos dados TCGA-GBM RNA-seq, onde as amostras com valores ausentes para a variável 'paper_IDH.status' foram removidos e os dados de expressão foram filtrados para manter apenas os genes com pelo menos 10 contagens em todas as amostras e assim permitir-nos filtrar as linhas da matriz (counts) que possuem baixos niveis de expressão em todas as amostras.

O resumo (summary(res)) mostra que dos 47.965 genes analisados, 3.464 (7,2%) foram up-regulated(Log2 fold change \> 0) nas amostras com status de tipo selvagem de IDH em comparação com aquelas com status de mutante de IDH. Por outro lado, 2.821 (5,9%) genes foram down-regulated (Log2 fold change \< 0) na mesma comparação.

Também podemos analisar que não houve outliers detetados nos dados e 13.020 genes (27%) tiveram contagens baixas (contagem média \< 1), que não foram usados na análise. Finalmente, o ponto de corte do valor de prova ajustado usado para determinar a significância foi menor que 0,1. Exploração Gráfica: De seguida vamos analisar o gráfico MA, para visualizar as diferenças de expressão génica entre dois grupos.



Portanto, se considerarmos aceitável uma fração de 10% de falsos positivos, podemos considerar todos os genes com valor de p ajustado abaixo de 10% = 0,1 como significativos. Existem 6285 genes significativos.


```{r}
sum(res$padj < 0.1, na.rm=TRUE)

#6285
```


**Exploração gráfica: MA Plot**

Este vai nos permitir para visualizar as diferenças de expressão génica entre dois grupos: Genes Diferencialmente Expressos(azul), Outros Genes (Cinza). E podemos observar também o TopGene que corresponde ao gene com menor valor de padj

```{r}
DESeq2::plotMA(res, ylim = c(-7,7))

topGene = rownames(res)[which.min(res$padj)]
with(res[topGene, ], {
  points(baseMean, log2FoldChange, col="dodgerblue", cex=2, lwd=2)
  text(baseMean, log2FoldChange, topGene, pos=2, col="dodgerblue")
})

```


Um gráfico de diagnóstico que também é útil é o histograma dos valores de p (figura abaixo). Este gráfico é melhor formado excluindo genes com contagens muito pequenas, que de outra forma geram picos no histograma.


**Normalização**

```{r}
hist(res$pvalue[res$baseMean > 1], breaks = 0:20/20,
     col = "grey50", border = "white", main=' Contagem média normalizada maior que 1')
```




## DE - Diferencal Expression - Genero

```{r}
data_rna_GBM$paper_Gender
a = as.factor(data_rna_GBM$paper_Gender)
qplot(data_rna_GBM$paper_Gender, fill=a) + ggtitle("Género dos Pacientes") 


```

```{r}
data_de = data_rna_GBM[,!is.na(data_rna_GBM$paper_Gender)]

ddsSE = DESeqDataSet(data_de, design = ~ paper_Gender)

keep = rowSums(counts(ddsSE)) >= 10
ddsSE = ddsSE[keep,]
ddsSE = DESeq(ddsSE)

resultsNames(ddsSE)

res = results(ddsSE, name = "paper_Gender_male_vs_female")
dea = as.data.frame(res)
summary(res)
```

A análise da Expressão Diferencial foi feita no subconjunto dos dados TCGA-GBM RNA-seq, onde as amostras com valores ausentes para a variável 'paper_Gender' foram removidos e os dados de expressão foram filtrados para manter apenas os genes com pelo menos 10 contagens em todas as amostras e assim permitir-nos filtrar as linhas da matriz (counts) que possuem baixos niveis de expressão em todas as amostras.

O resumo (summary(res)) mostra que dos 48091 genes analisados, 210 (0.44%) foram up-regulated(Log2 fold change \> 0) nas amostras com status de tipo selvagem de IDH em comparação com aquelas com status de mutante de IDH. Por outro lado, 115 (0.24%) genes foram down-regulated (Log2 fold change \< 0) na mesma comparação.

Também podemos analisar que não houve outliers detetados nos dados e 13.057 genes (27%) tiveram contagens baixas (contagem média \< 1), que não foram usados na análise. Finalmente, o ponto de corte do valor de prova ajustado usado para determinar a significância foi menor que 0,1.


Portanto, se considerarmos aceitável uma fração de 10% de falsos positivos, podemos considerar todos os genes com valor de p ajustado abaixo de 10% = 0,1 como significativos. Existem 325 genes significativos?

```{r}

sum(res$padj < 0.1, na.rm=TRUE)

#325
```



Subdefinimos a tabela de resultados para esses genes e, em seguida, classificamos pela estimativa de mudança de dobra de log2 para obter os genes significativos com a regulação negativa mais forte:

```{r}
resSig <- subset(res, padj < 0.1)
head(resSig[ order(resSig$log2FoldChange), ])
```
…e com a regulação positiva mais forte:


```{r}


head(resSig[ order(resSig$log2FoldChange, decreasing = TRUE), ])
```

Vamos ver o plot do gene que apresentou o menor valor de prova ajustado (padj), na comparação entre os grupos "male" e "female" do metadado "paper_Gender".


```{r}
topGene <- rownames(res)[which.min(res$padj)]
plotCounts(ddsSE, gene = topGene, intgroup=c("paper_Gender"))
```


**Exploração gráfica: MA Plot**



Exploração Gráfica: De seguida vamos analisar o gráfico MA, para visualizar as diferenças de expressão génica entre dois grupos.Genes Diferencialmente Expressos(azul), Outros Genes (Cinza) e adicionámos também o TopGene ao Gráfico.




```{r}

DESeq2::plotMA(res, ylim = c(-7,7))

topGene <- rownames(res)[which.min(res$padj)]
with(res[topGene, ], {
  points(baseMean, log2FoldChange, col="dodgerblue", cex=2, lwd=2)
  text(baseMean, log2FoldChange, topGene, pos=2, col="dodgerblue")
})
```


**Normalização**

```{r}
hist(res$pvalue[res$baseMean > 1], breaks = 0:20/20,
     col = "grey50", border = "white", main=' Contagem média normalizada maior que 1')
```



## DE - Estatistica descritiva Subtype

```{r}
data_rna_GBM$paper_Original.Subtype


a = as.factor(data_rna_GBM$paper_Original.Subtype)

qplot(data_rna_GBM$paper_Original.Subtype, fill=a)



```

```{r}
data_de = data_rna_GBM[,!is.na(data_rna_GBM$paper_Original.Subtype)]

ddsSE = DESeqDataSet(data_de, design = ~ paper_Original.Subtype)

keep = rowSums(counts(ddsSE)) >= 10
ddsSE = ddsSE[keep,]
ddsSE = DESeq(ddsSE)

resultsNames(ddsSE)

res = results(ddsSE, name = "paper_Original.Subtype_G.CIMP_vs_Classical")
dea = as.data.frame(res)
summary(res)
a = DESeq2::plotMA(res, ylim = c(-7,7), main="paper_Original.Subtype_G.CIMP_vs_Classical")
```

```{r}
res = results(ddsSE, name = "paper_Original.Subtype_Mesenchymal_vs_Classical")
dea = as.data.frame(res)
summary(res)

DESeq2::plotMA(res, ylim = c(-7,7),main="paper_Original.Subtype_Mesenchymal_vs_Classical")
topGene = rownames(res)[which.min(res$padj)]
with(res[topGene, ], {
  points(baseMean, log2FoldChange, col="dodgerblue", cex=2, lwd=2)
  text(baseMean, log2FoldChange, topGene, pos=2, col="dodgerblue")
})
```






```{r}
res = results(ddsSE, name = "paper_Original.Subtype_Neural_vs_Classical")
dea = as.data.frame(res)
summary(res)


DESeq2::plotMA(res, ylim = c(-7,7),main="paper_Original.Subtype_Neural_vs_Classical")
topGene <- rownames(res)[which.min(res$padj)]
with(res[topGene, ], {
  points(baseMean, log2FoldChange, col="dodgerblue", cex=2, lwd=2)
  text(baseMean, log2FoldChange, topGene, pos=2, col="dodgerblue")
})
```

```{r}
res = results(ddsSE, name = "paper_Original.Subtype_Proneural_vs_Classical")
dea = as.data.frame(res)
summary(res)


DESeq2::plotMA(res, ylim = c(-7,7),main="paper_Original.Subtype_Neural_vs_Classical")
topGene <- rownames(res)[which.min(res$padj)]
with(res[topGene, ], {
  points(baseMean, log2FoldChange, col="dodgerblue", cex=2, lwd=2)
  text(baseMean, log2FoldChange, topGene, pos=2, col="dodgerblue")
})



```



















```{r}
## dados clinicos


names(clinical.GBM)
head (clinical.GBM$clinical_drug_gbm )
df = as.data.frame(clinical.GBM$clinical_drug_gbm)
View(df)


```
